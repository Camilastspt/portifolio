@{
    /**/

    ViewBag.Title = "Horário Break";
}


<div class="page-wrapper">
    <div class="container-xl">
        <!-- Page title -->
        <div class="page-header d-print-none">
            <div class="row align-items-center">
                <div class="col">
                    <!-- Page pre-title -->

                    <h2 class="page-title">
                        BREAK
                    </h2>
                </div>

            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="row row-deck row-cards">
                <fieldset class="form-fieldset">
                    <div class="col-md-push-6">

                        <div class="card-header">

                            <label for="idPonto" class="form-label required"> Id Ponto</label>
                            <input style="width: 100%" type="text" class="form-control " id="idPonto" autocomplete="off" />
                            <div class="card-actions">
                            </div>
                            <div>
                                <a href="#" id="btnCarregarPonto" class="btn btn-primary">
                                    <!-- Download SVG icon from http://tabler-icons.io/i/plus -->

                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    Carregar ponto

                                </a>
                            </div>


                            <div>
                                <a style="margin: 5" href="#" id="btnUpdatePonto" class="btn btn-primary">
                                    <!-- Download SVG icon from http://tabler-icons.io/i/plus -->
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-refresh" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path>
                                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                                    </svg>                                        Atualizar ponto
                                </a>
                            </div>
                        </div>

                        <div class="card-body p-0">

                        </div>

                    </div>
            </div>

        </div>

    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="row row-deck row-cards">
                <fieldset class="form-fieldset">
                    <div class="col-md-push-6">

                        <div class="card-header">

                            <div class="mb-3">
                                <label class="form-label">Data Programação</label>
                                <div class="input-icon mb-2">

                                    <div class="input-icon">
                                        <span class="input-icon-addon">
                                            <!-- Download SVG icon from http://tabler-icons.io/i/calendar -->
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><rect x="4" y="5" width="16" height="16" rx="2"></rect><line x1="16" y1="3" x2="16" y2="7"></line><line x1="8" y1="3" x2="8" y2="7"></line><line x1="4" y1="11" x2="20" y2="11"></line><line x1="11" y1="15" x2="12" y2="15"></line><line x1="12" y1="15" x2="12" y2="18"></line></svg>
                                        </span>
                                        <input class="form-control" placeholder="Select a date" id="datepicker-icon-prepend" value="2020-06-20">
                                    </div>
                                </div>

                            </div>

                            <div class="card-body p-0">

                            </div>
                        </div>

                </fieldset>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="row row-deck row-cards">
                <fieldset class="form-fieldset">
                    <div class="col-md-push-6">

                        <div class="card-header">

                            <label for="qtdMusica" class="form-label required"> Qtd. Música</label>
                            <input style="width: 10%" type="text" class="form-control " id="qtdMusica" autocomplete="off" />

                            <label for="qtdSpot" class="form-label required"> Qtd. Spots</label>
                            <input style="width: 10%" type="text" class="form-control " id="qtdSpot" autocomplete="off" />

                            <label for="tempoSpot" class="form-label required"> Tempo Spot</label>
                            <input style="width: 10%" type="text" class="form-control " id="tempoSpot" autocomplete="off" />

                            <div style="width:auto">
                                <a href="#" id="btnUpdatePonto" class="btn btn-primary">
                                    <!-- Download SVG icon from http://tabler-icons.io/i/plus -->
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-bulb" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M3 12h1m8 -9v1m8 8h1m-15.4 -6.4l.7 .7m12.1 -.7l-.7 .7"></path>
                                        <path d="M9 16a5 5 0 1 1 6 0a3.5 3.5 0 0 0 -1 3a2 2 0 0 1 -4 0a3.5 3.5 0 0 0 -1 -3"></path>
                                        <line x1="9.7" y1="17" x2="14.3" y2="17"></line>
                                    </svg>                                        Criar novo Horário Break
                                </a>
                                <a href="#" id="btnUpdatePonto" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                                        <polyline points="7 11 12 16 17 11"></polyline>
                                        <line x1="12" y1="4" x2="12" y2="16"></line>
                                    </svg>                                       Gravar
                                </a>
                            </div>

                        </div>

                        <div class="card-body p-0">

                        </div>
                    </div>

                </fieldset>
            </div>
        </div>
    </div>
    <div class="page-body">
        <div class="container-xl">
            <div class="row row-deck row-cards">
                <fieldset class="form-fieldset">
                    <div class="col-md-push-6">

                        <div class="card-header">

                            <label for="tempoMusical" class="form-label required"> Tempo Musical</label>
                            <input style="width: 40%" type="text" class="form-control " id="tempoMusical" autocomplete="off"  />

                            <label for="tempoBreak" class="form-label required">Tempo Break</label>
                            <input style="width: 40%" type="text" class="form-control" id="tempoBreak" autocomplete="off"  />

                        </div>

                        <div class="card-body p-0">

                        </div>
                    </div>

                </fieldset>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="row row-deck row-cards">
                <fieldset class="form-fieldset">
                    <div class="col-md-push-6">

                        <div class="card-header">

                            <label for="horaInicial" class="form-label required">Hora Inicial</label>
                            <input style="width: 10%" type="text" class="form-control" id="horaInicial" disabled value="00:00:00" autocomplete="off" />
                            <label for="horaFinal" class="form-label required" >Hora Final</label>
                            <input style="width: 10%" type="text" class="form-control" id="horaFinal" disabled value="23:59:59" autocomplete="off"/>
                        </div>

                        <div class="card-body p-0">

                        </div>
                    </div>

                </fieldset>
            </div>
        </div>
    </div>

   
    <br />
    <div id="idProgramacao">
        <table>
            <thead>
                <tr>
                    <td style="min-width:80px;">Hora Break</td>
                    <td style="min-width:80px;">Break</td>
                    <td style="min-width:80px;">Hora Fim</td>
                    <td style="min-width:80px;">Id PI</td>
                    <td style="min-width:80px;">Impacto</td>
                    <td style="min-width:80px;">Tempo PI</td>
                </tr>
            </thead>
            <tbody id="tbProgramacao" style="text-align: center; padding: 3px; ">
            </tbody>
        </table>
    </div>

    <script>

        document.addEventListener("DOMContentLoaded", function () {
            window.Litepicker && (new Litepicker({
                element: document.getElementById('datepicker-icon-prepend'),
                buttonText: {
                    previousMonth: `<!-- Download SVG icon from http://tabler-icons.io/i/chevron-left -->
    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="15 6 9 12 15 18" /></svg>`,
                    nextMonth: `<!-- Download SVG icon from http://tabler-icons.io/i/chevron-right -->
    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="9 6 15 12 9 18" /></svg>`,
                },
            }));
        });

        document.addEventListener("DOMContentLoaded", function () {
            window.Litepicker && (new Litepicker({
                element: document.getElementById('datepicker-icon'),
                buttonText: {
                    previousMonth: `<!-- Download SVG icon from http://tabler-icons.io/i/chevron-left -->
    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="15 6 9 12 15 18" /></svg>`,
                    nextMonth: `<!-- Download SVG icon from http://tabler-icons.io/i/chevron-right -->
    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="9 6 15 12 9 18" /></svg>`,
                },
            }));
        });

    var programadoFuturo = true;

    $(function () {
        $('#dataProgramacao').datetimepicker({
            locale: 'pt-br',
            format: 'DD/MM/YYYY',
            defaultDate: 'now'
        });
    });

    function calcularSpot(qtdSpot, tempoSpot) {
        $("#tempoBreak").val(parseInt(qtdSpot * tempoSpot));
    }
    function calcularQtdMusica(qtdMusica, tempoMusical) {
        $("#tempoMusical").val(parseInt(qtdMusica * tempoMusical));
    }
    $("#qtdMusica").change(function () {
        calcularQtdMusica($(this).val(), 223);
    });


    $("#qtdSpot").change(function () {
        calcularSpot($(this).val(), $("#tempoSpot").val());
    });

    $("#tempoSpot").change(function () {
        calcularSpot($("#qtdSpot").val(), $(this).val());
    });

    function addZero(i) {
        if (i < 10) { i = "0" + i }
        return i;
    }
    btnCarregarPonto.onclick = function () {

        $("#tbProgramacao").html("");
           var data = {
               "IdPonto": parseInt($("#idPonto").val()),
               "Data": $("#dataProgramacao").find("input").val().split("/")[2] + '-' + $("#dataProgramacao").find("input").val().split("/")[1] + '-' + $("#dataProgramacao").find("input").val().split("/")[0]
            }
            $.ajax({
            url: "@Url.Action("GetPontoHorarioBreak", "HorarioBreak")",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            beforeSend: function () {
                {
                    $("#ModalCarregando").modal({
                        backdrop: 'static',
                        keyboard: false
                    });
                }
            },
                success: function (d) {
                    $("#btnCriarNovo").removeProp("disabled");
                    $("#btnUpdatePonto").removeProp("disabled");
                if (d) {
                    $("#qtdMusica").val(d.PontoConfiguracao.QtdMusicas);
                    $("#qtdSpot").val(d.PontoConfiguracao.QtdSpots);
                    $("#tempoSpot").val(d.PontoConfiguracao.TempoSpot);
                    programadoFuturo = d.PontoConfiguracao.ProgramadoFuturo;

                    calcularSpot($("#qtdSpot").val(), $("#tempoSpot").val());
                    if (d.HorarioBreak.length > 0) {
                        d.HorarioBreak.forEach(function (item, i) {
                            let retorno = `'<tr data-row="0" data-idBreak="">
                            <td>${item.Horario}</td>
                            <td>${d.PontoConfiguracao.TempoSpot}</td>
                            <td>${item.HorarioFim}</td>
                            <td>${item.IdPedido > 0 ? item.IdPedido : ''}</td>
                            <td>${item.Impacto}</td>
                            <td>${item.TempoAudio}</td>`;
                            $("#tbProgramacao").append(retorno);
                        });
                    }

                }
                else {
                    alert("Erro ao buscar informações do ponto: \n" + d);
                }
            }
            , error: function (jqXHR, textStatus, errorThrown) {
                alert("Error");
                $("#ModalCarregando").modal("hide");
            },
            complete: function () {
                $("#ModalCarregando").modal("hide");
            }
            });
        };

    btnCriarNovo.onclick = function () {
        $("#btnGravar").removeProp("disabled");
        $("#tbProgramacao").html("");

        var hora = $("#horaInicial").val();
        var horaFinal = $("#horaFinal").val();

        const d = new Date($("#dataProgramacao").find("input").val().split("/")[2] + '-' + $("#dataProgramacao").find("input").val().split("/")[1] + '-' + $("#dataProgramacao").find("input").val().split("/")[0] + ' '  + hora);
        const df = new Date($("#dataProgramacao").find("input").val().split("/")[2] + '-' + $("#dataProgramacao").find("input").val().split("/")[1] + '-' + $("#dataProgramacao").find("input").val().split("/")[0] + ' ' + horaFinal);
        var seconds = (df - d) / 1000;
        let h = addZero(d.getHours());
        let m = addZero(d.getUTCMinutes());
        let s = addZero(d.getUTCSeconds());
        let time = h + ":" + m + ":" + s;
        d.setSeconds(parseInt($("#tempoBreak").val()));
        h = addZero(d.getHours());
        m = addZero(d.getUTCMinutes());
        s = addZero(d.getUTCSeconds());
        let horafinal = h + ":" + m + ":" + s;

        var breakHora = getPI();
        var retorno = `'<tr data-row="0" data-idBreak="">
                        <td>${time}</td>
                        <td>${breakHora}</td>
                        <td>${horafinal}</td>
                        <td></td><td></td><td></td>`;
        $("#tbProgramacao").append(retorno);
        let breakSec = parseInt($("#tempoBreak").val());
        time = horafinal;
        var sec = breakSec
        var dn = new Date($("#dataProgramacao").find("input").val().split("/")[2] + '-' + $("#dataProgramacao").find("input").val().split("/")[1] + '-' + $("#dataProgramacao").find("input").val().split("/")[0] + ' '  + time);
        while (sec < seconds) {

            sec += parseInt($("#tempoMusical").val());

            if (sec >= seconds)
                break;

            dn = new Date($("#dataProgramacao").find("input").val().split("/")[2] + '-' + $("#dataProgramacao").find("input").val().split("/")[1] + '-' + $("#dataProgramacao").find("input").val().split("/")[0] + ' ' + hora);

            dn.setSeconds(sec);

            h = addZero(dn.getHours());
            m = addZero(dn.getUTCMinutes());
            s = addZero(dn.getUTCSeconds());
            time = h + ":" + m + ":" + s;

            sec += parseInt($("#tempoBreak").val());

            dn = new Date($("#dataProgramacao").find("input").val().split("/")[2] + '-' + $("#dataProgramacao").find("input").val().split("/")[1] + '-' + $("#dataProgramacao").find("input").val().split("/")[0] + ' ' + time);
            dn.setSeconds(dn.getSeconds() + parseInt($("#tempoBreak").val()));

            h = addZero(dn.getHours());
            m = addZero(dn.getUTCMinutes());
            s = addZero(dn.getUTCSeconds());
            horafinal = h + ":" + m + ":" + s;

            let retorno = `'<tr data-row="0" data-idBreak="">
                        <td>${time}</td>
                        <td>${breakHora}</td>
                        <td>${horafinal}</td>
                        <td></td><td></td><td></td>`;
            $("#tbProgramacao").append(retorno);
            time = horafinal;

        }
    };

    const getPI = function (idBreak) {
        if (idBreak) {

        }
        else
            return $("#tempoBreak").val();
    };


    btnUpdatePonto.onclick = function () {
        if (programadoFuturo) {
            if (confirm("Existe programação futura para esta configuração, deseja deleta-las?")) {
                updatePontoConfiguracao();
            }
        } else {
            updatePontoConfiguracao();
        }
    }
    const updatePontoConfiguracao = function () {

        var ponto = {
            "IdPonto": parseInt($("#idPonto").val()),
            "QtdMusicas": parseInt($("#qtdMusica").val()),
            "QtdSpots": parseInt($("#qtdSpot").val()),
            "TempoSpot": parseInt($("#tempoSpot").val())
        }

        $.ajax({
            url: "@Url.Action("UpdatePontoConfiguracao", "HorarioBreak")",
            type: "POST",
            data: JSON.stringify(ponto),
            beforeSend: function () {
                {
                    $("#ModalCarregando").modal({
                        backdrop: 'static',
                        keyboard: false
                    });
                }
            },
            contentType: "application/json; charset=utf-8",
            success: function (d) {
                if (d == true) {
                    alert("Ponto alterado com sucesso!!!");
                }
                else {
                    alert("Erro ao gravar a programação: \n" + d);
                }
            }
            , error: function (jqXHR, textStatus, errorThrown) {
                alert("Error");
                $("#ModalCarregando").modal("hide");
            },
            complete: function () {
                $("#ModalCarregando").modal("hide");
            }
        });
    };

    btnGravar.onclick = function () {

    getData((data) => {
            console.log(JSON.stringify(data));

        $.ajax({
            url: "@Url.Action("CriarHorarioBreak", "HorarioBreak")",
            type: "POST",
            data: JSON.stringify(data),
            beforeSend: function(){
                {
                    $("#ModalCarregando").modal({
                        backdrop: 'static',
                        keyboard: false
                    });
                }
            },
            contentType: "application/json; charset=utf-8",
            success: function (d) {
                if (d == true) {
                    alert("Pedido Programação Spot gravado com sucesso!!!");
                }
                else {
                    alert("Erro ao gravar a programação: \n" + d);
                }
            }
            , error: function (jqXHR, textStatus, errorThrown) {
                alert("Error");
                $("#ModalCarregando").modal("hide");
            },
            complete: function () {
                $("#ModalCarregando").modal("hide");
            }
            });
        });
    };

    const getData = function (callback) {
        var data = [], d = {};
        $('tr').each(function (i) {
            if (i > 1) {
                $(this).find('td').html();
                dn = new Date($("#dataProgramacao").find("input").val().split("/")[2] + '-' + $("#dataProgramacao").find("input").val().split("/")[1] + '-' + $("#dataProgramacao").find("input").val().split("/")[0] + ' ' + $(this).find('td')[0].innerText);
                h = addZero(dn.getHours());
                d = {
                        "IdHorario": h,
                        "Horario": $(this).find('td')[0].innerText,
                        "HorarioFim": $(this).find('td')[2].innerText,
                        "IdPonto": $("#idPonto").val()
                    }
                    data.push(d);
                }
        });
        return callback(data);
        }

    </script>
